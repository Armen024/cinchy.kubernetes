apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- ../../../../platform_components/idp
namespace: development
commonLabels:
  app: idp
  env: development
patchesJson6902:
- target:
    group: apps
    version: v1
    kind: Deployment
    name: idp-app
  patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/image
      value: 658484148438.dkr.ecr.ca-central-1.amazonaws.com/cinchy.idp:v5.4.0
    - op: add
      path: /spec/template/spec/volumes/-
      value: 
        name: idp-volume-redis-password
        secret:
          secretName: redis-redis-cluster
    - op: add
      path: /spec/template/spec/containers/0/volumeMounts/-
      value: 
        name: idp-volume-redis-password
        readOnly: true
        mountPath: "/usr/share/redis/redis-redis-cluster"
#    - op: replace
#      path: /spec/template/spec/volumes/0
#      value:
#        name: idp-volume-appsettings
#        csi:
#          driver: secrets-store.csi.k8s.io
#          readOnly: true
#          volumeAttributes:
#            secretProviderClass: "idp-secret-appsettings"
- target:
    group: secrets-store.csi.x-k8s.io
    version: v1
    kind: SecretProviderClass
    name: idp-secret-appsettings
  patch: |-
    - op: replace
      path: /spec/parameters
      value: 
        objects:  |
          - objectName: "idp-secret-appsettings-development"
            objectType: "secretsmanager"
            jmesPath:
            - path: idpsecretappsettings
              objectAlias: appsettings.json
- target:
    version: v1
    kind: Secret
    name: idp-secret-appsettings
  patch: |-
    - op: replace
      path: /data/appsettings.json
      value: ewogICJDb25maWdTZXR0aW5ncyI6IHsKICAgICJBcHBTZXR0aW5ncyI6IHsKICAgICAgIkNpbmNoeVVyaSI6ICJodHRwOi8vMjAuMTE5LjExNS4xNjkiLAogICAgICAiQ2VydGlmaWNhdGVQYXRoIjogIi9hcHAvY2luY2h5aWRlbnRpdHlzcnYucGZ4IiwKICAgICAgIkNlcnRpZmljYXRlUGFzc3dvcmQiOiAiIiwKICAgICAgIlNBTUxDbGllbnRFbnRpdHlJZCI6ICIiLAogICAgICAiU0FNTElEUEVudGl0eUlkIjogIiIsCiAgICAgICJTQU1MTWV0YWRhdGFYbWxQYXRoIjogIiIsCiAgICAgICJTQU1MU1NPU2VydmljZVVSTCI6ICIiLAogICAgICAiU0FNTEVuY3J5cHRlZENlcnRpZmljYXRlUGF0aCI6ICIiLAogICAgICAiU0FNTEVuY3J5cHRlZENlcnRpZmljYXRlUGFzc3dvcmQiOiAiIiwKICAgICAgIlNBTUxTaWduQ2VydGlmaWNhdGVQYXRoIjogIiIsCiAgICAgICJTQU1MU2lnbkNlcnRpZmljYXRlUGFzc3dvcmQiOiAiIiwKICAgICAgIkFjc1VSTE1vZHVsZSI6ICIiLAogICAgICAiU3RzUHVibGljT3JpZ2luVXJpIjogImh0dHA6Ly8yMC4xMTkuMTE1LjE2OS9pZHAiLAogICAgICAiTWF4UmVxdWVzdEhlYWRlcnNUb3RhbFNpemUiOiA2NTUzNiwKICAgICAgIk1heFJlcXVlc3RCdWZmZXJTaXplIjogNjU1MzYsCiAgICAgICJNYXhSZXF1ZXN0Qm9keVNpemUiOiAtMSwKICAgICAgIk1hY2hpbmVLZXlYbWwiOiAiIiwKICAgICAgIkRwQXBpS2V5UmluZ1BhdGgiOiAiIiwKICAgICAgIlRsc1ZlcnNpb24iOiAiMS4yIiwKICAgICAgIkNpbmNoeUFjY2Vzc1Rva2VuTGlmZXRpbWUiOiAiPDxjaW5jaHlfc2Vzc2lvbl90aW1lb3V0Pj4iLAogICAgICAiRGF0YUNoYW5nZUNhbGxiYWNrVGltZW91dCI6IDcsCiAgICAgICJSZWZyZXNoQ2FjaGVUaW1lSW5NaW4iOiAxMCwKICAgICAgIkRlZmF1bHRFeHBpcmF0aW9uQ2FjaGVUaW1lSW5NaW4iOiAzNjAsCiAgICAgICJEQlR5cGUiOiAiVFNRTCIKICAgIH0sCiAgICAiQ29ubmVjdGlvblN0cmluZ3MiOiB7CiAgICAgICJTcWxTZXJ2ZXIiOiAiU2VydmVyPXRjcDpub25wcm9kc3FsYWN1bWVuLXByaW1hcnkuZGF0YWJhc2Uud2luZG93cy5uZXQsMTQzMztJbml0aWFsIENhdGFsb2c9ZGV2ZWxvcG1lbnQ7UGVyc2lzdCBTZWN1cml0eSBJbmZvPUZhbHNlO1VzZXIgSUQ9c3FsYWRtaW47UGFzc3dvcmQ9QTFzMmQzZjQjO011bHRpcGxlQWN0aXZlUmVzdWx0U2V0cz1GYWxzZTtFbmNyeXB0PVRydWU7VHJ1c3RTZXJ2ZXJDZXJ0aWZpY2F0ZT1GYWxzZTtDb25uZWN0aW9uIFRpbWVvdXQ9MzA7IiwKICAgICAgIlJlZGlzIjogInJlZGlzLXJlZGlzLWNsdXN0ZXIucmVkaXMuc3ZjLmNsdXN0ZXIubG9jYWw6NjM3OSIKICAgIH0sCiAgICAiRXh0ZXJuYWxJZGVudGl0eUNsYWltU2VjdGlvbiI6IHsKICAgICAgIkZpcnN0TmFtZSI6IHsKICAgICAgICAiRXh0ZXJuYWxDbGFpbU5hbWUiOiAiIgogICAgICB9LAogICAgICAiTGFzdE5hbWUiOiB7CiAgICAgICAgIkV4dGVybmFsQ2xhaW1OYW1lIjogIiIKICAgICAgfSwKICAgICAgIkVtYWlsIjogewogICAgICAgICJFeHRlcm5hbENsYWltTmFtZSI6ICIiCiAgICAgIH0sCiAgICAgICJNZW1iZXJPZiI6IHsKICAgICAgICAiRXh0ZXJuYWxDbGFpbU5hbWUiOiAiIgogICAgICB9CiAgICB9LAogICAgIkNsdXN0ZXJDb21tdW5pY2F0aW9uU2V0dGluZ3MiOiB7CiAgICAgICJVc2VLYWZrYSI6IHRydWUsCiAgICAgICJLYWZrYUNhY2hlVG9waWMiOiAiIiwKICAgICAgIkthZmthQ2xpZW50Q29uZmlnIjogewogICAgICAgICJCb290c3RyYXBTZXJ2ZXJzIjogImthZmthLWNsdXN0ZXIta2Fma2EtYm9vdHN0cmFwLmthZmthLnN2Yy5jbHVzdGVyLmxvY2FsOjkwOTIiCiAgICAgIH0sCiAgICAgICJDbHVzdGVySXBBZGRyZXNzZXMiOiAiIiwKICAgICAgIkNsdXN0ZXJDb21tdW5pY2F0aW9uUHJvdG9jb2wiOiAiaHR0cCIsCiAgICAgICJDbHVzdGVyQ29tbXVuaWNhdGlvbkJhc2VVcmwiOiAie1BST1RPQ09MfTovL3tJUEFERFJFU1N9L0NpbmNoeSIKICAgIH0KICB9LAogICJMb2dnaW5nIjogewogICAgIkxvZ0xldmVsIjogewogICAgICAiRGVmYXVsdCI6ICJEZWJ1ZyIKICAgIH0KICB9LAogICJTZXJpbG9nIjogewogICAgIk1pbmltdW1MZXZlbCI6IHsKICAgICAgIkRlZmF1bHQiOiAiRGVidWciLAoJICAiT3ZlcnJpZGUiOiB7CgkJIk1pY3Jvc29mdCI6ICJXYXJuaW5nIiwKCQkiTWljcm9zb2Z0Lkhvc3RpbmcuTGlmZXRpbWUiOiAiSW5mb3JtYXRpb24iCgkgIH0KICAgIH0sCiAgICAiV3JpdGVUbyI6IFsKICAgICAgewogICAgICAgICJOYW1lIjogIkNvbnNvbGUiLAogICAgICAgICJBcmdzIjogewogICAgICAgICAgImZvcm1hdHRlciI6ICJTZXJpbG9nLkZvcm1hdHRpbmcuQ29tcGFjdC5Db21wYWN0SnNvbkZvcm1hdHRlciwgU2VyaWxvZy5Gb3JtYXR0aW5nLkNvbXBhY3QiCiAgICAgICAgfQogICAgICB9CiAgICBdCiAgfQp9
- target:
    group: logging.banzaicloud.io
    version: v1beta1
    kind: Output
    name: idp-logging-stdout
  patch: |-
    - op: replace
      path: /spec/elasticsearch/index_name
      value: development-idp-app
- target:
    group: networking.istio.io
    version: v1alpha3
    kind: DestinationRule
    name: idp-destinationrule
  patch: |-
    - op: replace
      path: /spec/trafficPolicy/loadBalancer/consistentHash/httpCookie/name
      value: development-idp-canary
